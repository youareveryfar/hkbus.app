import{j as i,r as g,D as O,A as E,e as G,J as M,S as I,o as j}from"./index-BZAXjjD_.js";import{c as _,l as B,b as T,e as W,M as Z,T as L,L as k,a as V}from"./TileLayer-BM2OEKST.js";import{S as D,C as H}from"./CompassControl-CCT03F-n.js";import{c as P,b as A}from"./App-heRoAE-M.js";import"./index-mhOicfQu.js";const q=P(i.jsx("path",{d:"M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4m8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7"}),"MyLocation"),z=_(function({data:a,...r},f){const b=new B.GeoJSON(a,r);return T(b,W(f,{overlayContainer:b}))},function(a,r,f){r.style!==f.style&&(r.style==null?a.resetStyle():a.setStyle(r.style))}),X=(t,a)=>{const[r,f]=g.useState(null),{db:{routeList:b}}=g.useContext(O),{gtfsId:y,bound:$,co:h}=b[t];return g.useEffect(()=>{let p="";return y?p=`${y}-${$[h[0]]==="I"?"I":"O"}.json`:h.includes("mtr")&&(p=`${t.split("-")[0].toLowerCase()}.json`),fetch(`https://hkbus.github.io/route-waypoints/${p}`).then(d=>d.json()).then(d=>{f(d)}).catch(()=>{f({features:[{type:"Feature",geometry:{type:"LineString",coordinates:a.reduce((d,{location:{lat:v,lng:C}})=>(d.push([C,v]),d),[])}}],type:"FeatureCollection"})}),()=>{f(null)}},[t,y,$,h,a]),r},K=({onClick:t})=>i.jsx("div",{className:"leaflet-bottom leaflet-right",children:i.jsx(A,{sx:Y,className:"leaflet-control leaflet-bar",onClick:t,children:i.jsx(q,{className:e.centerControl})})}),oe=({routeId:t,stopIds:a,stopIdx:r,route:f,companies:b,onMarkerClick:y})=>{var x;const{geolocation:$,geoPermission:h,updateGeoPermission:p,colorMode:d}=g.useContext(E),{db:{stopList:v}}=g.useContext(O),C=G(),[l,J]=g.useState(null),s=g.useMemo(()=>a.map(o=>v[o]),[v,a]),m=X(t,s),n=g.useRef({initialCenter:s[r]?s[r].location:M(),currentStopCenter:s[r]?s[r].location:M(),center:s[r]?s[r].location:M(),isFollow:!1,stops:s,stopIdx:r});g.useEffect(()=>{var w,N;let o,u;n.current.stops!==s||n.current.stopIdx!==r?o=!1:o=n.current.isFollow,n.current.stops===s&&n.current.stopIdx===r&&o?u=$.current:u=s[r]?s[r].location:M();const S=n.current.center;S!==u&&!I(u,S)&&(n.current.stops!==s?(w=n.current.map)==null||w.setView(u):(N=n.current.map)==null||N.flyTo(u)),n.current={...n.current,center:u,currentStopCenter:s[r]?s[r].location:M(),stops:s,stopIdx:r,isFollow:o}},[s,r,$]),g.useEffect(()=>{if(l){n.current={...n.current,map:l};const o=()=>{n.current={...n.current,center:n.current.currentStopCenter,isFollow:!1}};return l==null||l.on({dragend:o,dragstart:o}),l==null||l.setView(n.current.center),l==null||l.invalidateSize(),()=>{l.off({dragstart:o,dragend:o})}}},[l]);const R=g.useCallback(()=>{var o;h==="granted"?((o=n.current.map)==null||o.flyTo($.current),n.current={...n.current,center:$.current,isFollow:!0}):h!=="denied"&&(n.current={...n.current,isFollow:!0},p("opening"))},[$,h,p]);return i.jsx(A,{id:"route-map",sx:U,children:i.jsxs(Z,{center:n.current.initialCenter,zoom:16,scrollWheelZoom:!1,className:e.mapContainer,ref:J,children:[i.jsx(L,{crossOrigin:"anonymous",maxZoom:k.Browser.retina?20:19,maxNativeZoom:18,keepBuffer:10,updateWhenIdle:!1,url:d==="light"?"https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/voyager_nolabels/{z}/{x}/{y}.png":"https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_nolabels/{z}/{x}/{y}.png"}),i.jsx(L,{crossOrigin:"anonymous",maxZoom:k.Browser.retina?20:19,maxNativeZoom:18,keepBuffer:10,updateWhenIdle:!1,attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="https://carto.com/attributions">CARTO</a> © <a href="https://api.portal.hkmapservice.gov.hk/disclaimer">地圖版權屬香港特別行政區政府</a>',url:"https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/label/hk/{lang}/WGS84/{z}/{x}/{y}.png".replace("{lang}",C==="zh"?"tc":"en")}),s.map((o,u)=>i.jsx(V,{position:o.location,icon:Q({active:u===r,passed:u<r,companies:b}),alt:`${u}. ${o.name[C]}`,eventHandlers:{click:S=>{y(u,S)}}},`${o.location.lng}-${o.location.lat}-${u}`)),((x=m==null?void 0:m.features)==null?void 0:x.length)&&i.jsxs(i.Fragment,{children:[i.jsx(z,{data:m,style:F(b,f,!0)},m==null?void 0:m.timeStamp),i.jsx(z,{data:m,style:F(b,f,!1)},m==null?void 0:m.timeStamp)]}),i.jsx(D,{}),i.jsx(K,{onClick:R}),i.jsx(H,{})]})})},F=(t,a,r)=>function(){return{color:r?"#000000":j(t,a),weight:r?6:4,className:t.includes("ctb")&&t.includes("kmb")&&!r?e.jointlyLine:void 0}},Q=({active:t,passed:a,companies:r})=>r[0]==="mtr"?k.divIcon({iconSize:[20,20],iconAnchor:[10,10],className:`${e.mtrMarker} ${e.marker} ${t?e.active:""} ${a?e.passed:""}`}):r.includes("lightRail")?k.divIcon({iconSize:[20,20],iconAnchor:[10,10],className:`${e.mtrMarker} ${e.marker} ${t?e.active:""} ${a?e.passed:""}`}):r[0].startsWith("gmb")?k.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.gmbMarker} ${e.marker} ${t?e.active:""} ${a?e.passed:""}`}):r.includes("lrtfeeder")?k.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.lrtfeederMarker} ${e.marker} ${t?e.active:""} ${a?e.passed:""}`}):r.includes("nlb")?k.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.nlbMarker} ${e.marker} ${t?e.active:""} ${a?e.passed:""}`}):r.includes("ctb")&&r.includes("kmb")?k.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.jointlyMarker} ${e.marker} ${t?e.active:""} ${a?e.passed:""}`}):r.includes("ctb")?k.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.ctbMarker} ${e.marker} ${t?e.active:""} ${a?e.passed:""}`}):k.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:`${e.kmbMarker} ${e.marker} ${t?e.active:""} ${a?e.passed:""}`}),c="routeMap",e={mapContainerBox:`${c}-mapContainerBox`,mapContainer:`${c}-mapContainer`,centerControl:`${c}-centerControl`,marker:`${c}-marker`,mtrMarker:`${c}-mtrMarker`,gmbMarker:`${c}-gmbMarker`,ctbMarker:`${c}-ctbMarker`,jointlyMarker:`${c}-jointlyMarker`,lrtfeederMarker:`${c}-lrtfeederMarker`,nlbMarker:`${c}-nlbMarker`,kmbMarker:`${c}-kmbMarker`,jointlyLine:`${c}-jointlyLine`,active:`${c}-active`,passed:`${c}-passed`},U={height:"35vh",filter:t=>t.palette.mode==="dark"?"brightness(0.8)":"none",[`& .${e.mapContainer}`]:{height:"35vh"},[`& .${e.mtrMarker}`]:{backgroundImage:"url(/img/mtr.svg)"},[`& .${e.gmbMarker}`]:{backgroundImage:"url(/img/minibus.svg)"},[`& .${e.ctbMarker}`]:{backgroundImage:"url(/img/bus_ctb.svg)"},[`& .${e.jointlyMarker}`]:{backgroundImage:"url(/img/bus_jointly.svg)"},[`& .${e.lrtfeederMarker}`]:{backgroundImage:"url(/img/bus_lrtfeeder.svg)"},[`& .${e.nlbMarker}`]:{backgroundImage:"url(/img/bus_nlb.svg)"},[`& .${e.kmbMarker}`]:{backgroundImage:"url(/img/bus_kmb.svg)"},[`& .${e.jointlyLine}`]:{stroke:j(["kmb"],""),animation:`${e.jointlyLine}-color 10s infinite linear 1.5s`},[`@keyframes ${e.jointlyLine}-color`]:{"50%":{stroke:j(["ctb"],"")},"100%":{stroke:j(["kmb"],"")}},[`& .${e.active}`]:{animation:"blinker 1.5s infinite"},[`& .${e.passed}`]:{filter:"grayscale(100%)"},"& .self-center":{backgroundImage:"url(/img/self.svg)",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center",transition:"transform 0.1s ease-out",transformOrigin:"center"}},Y={background:"white",width:32,height:32,marginBottom:"20px !important",marginRight:"5px !important",display:"flex",justifyContent:"center",alignItems:"center",[`& .${e.centerControl}`]:{padding:"3px",color:"black"}};export{oe as default};
